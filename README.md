# STRM 整理工具（MoviePilot V2 版）详细使用说明
## 概述
本文档详细介绍 MoviePilot V2 专属插件「STRM 整理工具」的安装、配置、使用及问题排查，该插件支持 **STRM 文件缺失扫描、批量删除、完整库复制** 三大核心功能，附带 CSV 报告生成、定时任务、模拟运行等辅助功能，保障影视库 STRM 文件整理的安全性和高效性。

## 1.  核心功能详解
| 操作模式 | 功能描述 | 适用场景 | 安全性 | 补充说明 |
|----------|----------|----------|--------|----------|
| 仅扫描（`scan`） | 遍历指定影视库，筛选「缺失 STRM 文件的最终媒体目录」，生成结构化 CSV 报告，无任何文件修改操作 | 1. 首次使用插件排查 STRM 缺失情况<br>2. 定期巡检影视库 STRM 文件状态<br>3. 验证其他操作的待处理目录列表 | 🌟 绝对安全（只读操作，不修改任何文件/目录） | CSV 报告自动添加「年月日_时分秒」后缀，避免覆盖旧报告 |
| 删除 STRM（`delete`） | 批量删除「缺失 STRM 目录」中的所有 `.strm` 格式文件 | 1. 清理影视库中无效/冗余的 STRM 文件<br>2. 整理影视库结构，删除无用缓存文件 | ⚠️ 高风险（永久删除文件，不可恢复） | 强烈建议先开启「模拟运行」验证删除列表，再执行实际操作 |
| 复制 STRM（`copy`） | 从「完整影视库」复制对应目录的 STRM 文件及元文件（封面、字幕等），保留原始目录结构到指定输出路径 | 1. 快速补全目标影视库的 STRM 文件<br>2. 迁移 STRM 库，保留完整目录结构<br>3. 备份重要 STRM 文件及元数据 | ✅ 相对安全（仅复制文件，不修改源目录） | 目标路径不存在会自动递归创建，已存在的文件不会覆盖 |

## 2.  安装步骤
### 前置条件
- 已部署 MoviePilot V2.x 版本（不兼容 V1 版本）
- 拥有 Github 账号（用于 fork 插件仓库，可选）
- MoviePilot 具备外部插件源配置权限

### 步骤 1：Fork 插件仓库
1.  打开插件仓库地址（示例：`https://github.com/Daveccx/MoviePilot-Plugins`）
2.  点击仓库右上角「Fork」，将插件仓库复制到你的个人 Github 账号下
3.  等待 fork 完成，获取你的个人插件仓库地址（格式：`https://github.com/你的用户名/MoviePilot-Plugins`）

### 步骤 2：配置 MoviePilot 插件源
1.  登录 MoviePilot V2 后台，进入「设定」→「插件」→「插件市场」
2.  点击「添加插件源」，填写以下信息：
    - 源名称：自定义（如「STRM 整理工具源」）
    - 源地址：你的个人插件仓库地址（步骤 1 中获取）
    - 描述：可选（如「STRM 文件整理专用插件」）
3.  点击「保存」，等待插件源同步完成

### 步骤 3：安装插件
1.  在插件市场中，找到「strm整理工具」（筛选标签「STRM」可快速定位）
2.  点击插件卡片上的「安装」，等待安装进度完成（无需额外下载依赖）
3.  安装完成后，插件状态显示「已安装」，可进入「我的插件」查看详情

### 步骤 4：验证安装
1.  进入「我的插件」，找到「strm整理工具」
2.  点击「配置」，若能正常打开配置页面，说明安装成功
3.  若安装失败，可刷新插件源或检查仓库地址是否正确

## 3.  配置项完整说明
插件配置页面采用 Vuetify 表单布局，所有配置项如下表所示（带 * 为必填项，仅对应操作模式下必填）：

| 配置项 | 对应组件 | 取值范围 | 默认值 | 必填性 | 核心说明 |
|--------|----------|----------|--------|--------|----------|
| 启用插件 | 开关（VSwitch） | True/False | False | 否 | 开启后插件生效，定时任务可正常运行；关闭后所有任务停止 |
| 立即运行一次 | 开关（VSwitch） | True/False | False | 否 | 保存配置后 3 秒内执行一次任务，执行完成后自动重置为 False |
| 模拟运行（Dry-Run） | 开关（VSwitch） | True/False | False | 否 | 仅打印操作日志，不执行实际的「删除/复制」操作，用于验证任务有效性 |
| 操作类型 | 下拉选择（VSelect） | `scan`/`delete`/`copy` | `scan` | 是 | 选择插件要执行的核心操作，不支持自定义值 |
| 定时执行周期 | 文本框（VTextField） | 5 位 cron 表达式 | 空（关闭定时） | 否 | 配置定时任务执行周期，留空则关闭定时，格式：`分 时 日 月 周` |
| 当前影视库根路径 | 文本框（VTextField） | 合法目录路径 | 空 | 是（所有模式） | 要扫描/删除 STRM 的目标影视库根路径，需具备**读取权限**（删除模式需额外具备写入权限） |
| 完整影视库路径 | 文本框（VTextField） | 合法目录路径 | 空 | 是（仅 `copy` 模式） | 复制 STRM 文件的源目录，需具备**读取权限**，目录结构建议与「当前影视库」一致 |
| 复制输出路径 | 文本框（VTextField） | 合法目录路径 | 空 | 是（仅 `copy` 模式） | 复制 STRM 文件的目标目录，需具备**写入权限**，不存在会自动递归创建 |
| 最大工作线程数 | 数字输入框（VTextField） | 1-32 | 8 | 否 | 多线程处理文件的最大线程数，过高可能占用过多系统资源，过低会降低处理效率 |
| 结果 CSV 文件名称 | 文本框（VTextField） | 合法文件名（带 `.csv` 后缀） | `strm_result.csv` | 否 | 生成的缺失 STRM 目录报告文件名，自动添加日期后缀，避免覆盖旧文件 |

### 补充：cron 表达式示例
| 需求 | cron 表达式 | 说明 |
|------|-------------|------|
| 每天凌晨 0 点执行 | `0 0 * * *` | 分=0、时=0、日=任意、月=任意、周=任意 |
| 每天凌晨 2 点 30 分执行 | `30 2 * * *` | 分=30、时=2、日=任意、月=任意、周=任意 |
| 每周日凌晨 1 点执行 | `0 1 * * 0` | 分=0、时=1、日=任意、月=任意、周=0（周日） |
| 每月 1 号凌晨 3 点执行 | `0 3 1 * *` | 分=0、时=3、日=1、月=任意、周=任意 |

## 4.  分步使用指南
### 场景 1：首次使用 - 仅扫描 STRM 缺失目录
1.  进入插件配置页面，保持「操作类型」为 `scan`（仅扫描）
2.  填写「当前影视库根路径」（如 `/mnt/media` 或 `D:/media`）
3.  （可选）修改「结果 CSV 文件名称」和「最大工作线程数」
4.  开启「立即运行一次」，保持「启用插件」为 False（无需长期运行）
5.  点击「保存」，等待 3 秒后任务开始执行
6.  任务完成后，查看 MoviePilot 系统消息（右上角铃铛图标），获取 CSV 报告路径
7.  打开 CSV 报告，排查缺失 STRM 的目录列表，为后续操作做准备

### 场景 2：清理无效 STRM - 批量删除操作
> ⚠️ 高风险操作，务必先执行「模拟运行」验证，建议备份重要数据！

1.  先按照「场景 1」执行「仅扫描」，确认待删除目录列表无误
2.  进入插件配置页面，将「操作类型」切换为 `delete`（删除 STRM）
3.  确认「当前影视库根路径」填写正确，开启「模拟运行」
4.  开启「立即运行一次」，点击「保存」，查看任务日志
5.  检查日志中的「模拟删除」列表，确认无误操作目标
6.  关闭「模拟运行」，再次开启「立即运行一次」，点击「保存」执行实际删除
7.  任务完成后，查看系统消息，确认删除目录数及执行结果

### 场景 3：补全 STRM 文件 - 批量复制操作
1.  进入插件配置页面，将「操作类型」切换为 `copy`（复制 STRM）
2.  填写必填路径：
    - 「当前影视库根路径」：待补全 STRM 的目标库路径
    - 「完整影视库路径」：包含完整 STRM 文件的源库路径
    - 「复制输出路径」：STRM 文件的复制目标路径（建议新建空目录）
3.  （可选）开启「模拟运行」，验证复制列表和目录结构
4.  开启「立即运行一次」，点击「保存」执行任务
5.  任务完成后，进入「复制输出路径」，检查目录结构是否完整、STRM 文件是否正常复制
6.  （可选）将复制后的目录迁移到目标影视库，完成 STRM 文件补全

### 场景 4：长期巡检 - 配置定时任务
1.  进入插件配置页面，选择所需「操作类型」（建议优先 `scan`）
2.  填写所有必填配置项，确认配置无误
3.  填写「定时执行周期」（如 `0 0 * * *` 每天凌晨执行）
4.  开启「启用插件」，点击「保存」
5.  进入 MoviePilot 「设定」→「服务」，找到「STRM整理工具定时任务」，确认任务状态为「运行中」
6.  定时任务会按照配置周期自动执行，执行结果可在系统消息中查看

## 5.  重要注意事项
1.  **数据安全优先**：删除模式会永久删除文件，无回收站/备份，务必先通过「模拟运行」验证，且备份重要数据。
2.  **路径权限保障**：
    - Linux/MacOS：确保 MoviePilot 运行用户（如 `root`、`moviepilot`）对配置的所有路径具备对应权限（读取/写入/执行）。
    - Windows：确保 MoviePilot 进程对配置的文件夹具备「完全控制」权限，避免路径包含中文/特殊字符（如 `#`、`@`）。
3.  **跨平台路径兼容**：配置路径时统一使用 `/` 作为分隔符（如 `D:/media/movie`），MoviePilot 会自动转换为对应系统的分隔符（Windows 为 `\`）。
4.  **大目录处理优化**：遍历大型影视库（1000+ 目录/文件）可能需要较长时间，建议选择系统空闲时段执行，避免占用过多 CPU/IO 资源，影响其他服务运行。
5.  **CSV 报告兼容**：报告采用 `UTF-8 BOM` 编码，可直接用 Microsoft Excel、WPS、记事本打开，避免中文路径乱码；若打开乱码，可手动选择「UTF-8」编码导入。
6.  **避免符号链接循环**：插件会自动跳过符号链接（`os.walk(followlinks=False)`），请勿将配置路径设置为符号链接目录，避免无限循环遍历。
7.  **插件更新说明**：插件更新后，原有配置会保留，无需重新填写；若更新后出现异常，可先禁用插件再启用，或重置配置为默认值。

## 6.  常见问题排查
### Q1：任务执行失败，提示「路径无效」
#### 现象
系统消息提示「当前影视库路径无效」/「完整影视库路径无效」，任务终止。
#### 解决方案
1.  检查路径是否填写正确，是否存在对应的目录（可通过 MoviePilot 终端/主机终端验证路径是否存在）。
2.  检查路径是否包含空格/特殊字符（如 ` `、`$`、`*`），建议修改为无特殊字符的路径。
3.  检查 MoviePilot 对该路径的权限，确保具备「读取」权限（删除/复制模式需额外具备「写入」权限）。
4.  避免使用相对路径，全部使用绝对路径（如 `/mnt/media` 而非 `./media`）。

### Q2：复制模式无文件复制，日志提示「完整库中未找到对应目录」
#### 现象
任务执行完成，但输出路径无文件，日志中大量提示「完整库中未找到对应目录」。
#### 解决方案
1.  检查「当前影视库根路径」和「完整影视库路径」的目录结构是否一致，插件通过「相对路径」匹配对应目录。
    - 示例：当前影视库路径 `(/mnt/media/movie/《流浪地球》)` 对应完整影视库路径应是 `(/mnt/full_media/movie/《流浪地球》)`。
2.  检查完整影视库中是否存在对应的目录及 STRM 文件，确保目录名称、层级一致。
3.  检查路径是否包含大小写差异（Linux/MacOS 区分大小写，Windows 不区分），建议保持目录名称大小写一致。

### Q3：定时任务不执行，服务列表中无对应任务
#### 现象
已配置 cron 表达式并开启插件，但定时任务不执行，「服务」列表中找不到「STRM整理工具定时任务」。
#### 解决方案
1.  检查 cron 表达式是否有效，可通过在线 cron 验证工具（如 `https://crontab.guru/`）验证格式。
2.  检查插件是否已「启用」，仅启用插件后，定时任务才会注册到 MoviePilot 服务列表。
3.  检查 cron 表达式是否填写错误（如多写/少写字段，5 位表达式不可包含秒级）。
4.  禁用插件再重新启用，或重启 MoviePilot 主程序，重新注册定时任务。

### Q4：CSV 报告无法打开，或打开后无数据
#### 现象
任务执行完成，但 CSV 报告无法打开，或打开后仅有表头，无目录数据。
#### 解决方案
1.  检查任务日志，确认是否「无缺失 STRM 的目录」，若日志提示「无缺失 STRM 的目录，无需生成 CSV 报告」，则无数据属于正常现象。
2.  用记事本打开 CSV 报告，检查文件是否为空；若为空，说明扫描任务未正常执行，可重新执行一次「仅扫描」任务。
3.  若打开乱码，可手动用 Excel 「数据」→「自文本/CSV」导入，选择「UTF-8」编码，分隔符选择「逗号」。
4.  检查「结果 CSV 文件名称」是否填写正确，是否包含 `.csv` 后缀，建议使用默认文件名 `strm_result.csv`。

### Q5：多线程处理时，CPU 占用过高
#### 现象
任务执行过程中，主机 CPU 占用率达到 100%，其他服务响应缓慢。
#### 解决方案
1.  降低「最大工作线程数」，建议从 8 调整为 4 或 2，减少 CPU 资源占用。
2.  选择系统空闲时段执行任务，避免在高峰时段（如白天观影、下载任务运行时）执行。
3.  拆分大型影视库为多个小目录，分批次执行任务，避免一次性遍历过多目录。

## 7.  附录
### 支持的元文件格式
插件在复制模式中，会同步复制以下元文件（用于保留影视库的封面、字幕等信息）：
- 图片格式：`.jpg`、`.png`、`.webp`
- 字幕格式：`.srt`、`.ass`、`.ssa`
- 信息格式：`.nfo`

### 插件数据存储路径
- CSV 报告存储路径：`MoviePilot 安装目录/data/plugins/`
- 插件配置存储路径：`MoviePilot 安装目录/data/config/system.json`（不建议手动修改）
- 插件日志路径：`MoviePilot 安装目录/logs/moviepilot.log`（可通过日志排查详细错误）
